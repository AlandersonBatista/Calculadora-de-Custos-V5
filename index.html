<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Calculadora de Custos</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="icons/icon-512.png">
  <!-- jsPDF para gerar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --card:#1f2937; --muted:#94a3b8;
      --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --yellow:#facc15;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(120deg,var(--bg),#020617);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    }
    .wrap{max-width:720px;margin:0 auto;padding:16px 16px 64px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px;flex-wrap:wrap}
    h1{font-size:clamp(20px,4vw,28px);margin:8px 0}
    .pill{display:inline-block;background:#0c2235;border:1px solid #1e3a5f;color:#bcd2eb;
      padding:4px 8px;border-radius:999px;font-size:12px}
    .card{
      background:var(--card);
      border:1px solid #223046;
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 20px rgb(0 0 0 / .25);
      margin-bottom:16px;
    }
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:14px;color:var(--muted);display:block;margin-bottom:4px}
    input,textarea,button{
      font-family:inherit;
    }
    input,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid #2a3a4f;
      border-radius:10px;
      background:#0f1b2a;
      color:#e5e7eb;
      font-size:15px;
      outline:none;
    }
    input:focus,textarea:focus{
      border-color:#60a5fa;
      box-shadow:0 0 0 1px #1d4ed8;
    }
    input[readonly],textarea[readonly]{
      background:#020617;
      color:#cbd5f5;
    }
    input::placeholder,textarea::placeholder{color:#6b7b8d}
    .hint{font-size:12px;color:var(--muted);margin-top:2px}
    .btn{
      width:100%;
      margin-top:8px;
      padding:12px;
      border-radius:10px;
      border:1px solid #244a34;
      background:#11251a;
      color:#c6f6d5;
      font-weight:700;
      cursor:pointer;
      font-size:14px;
    }
    .btn-secondary{
      width:100%;
      margin-top:8px;
      padding:10px;
      border-radius:10px;
      border:1px solid #334155;
      background:#020617;
      color:#e5e7eb;
      font-size:14px;
      cursor:pointer;
    }
    .btn-danger{
      width:100%;
      margin-top:8px;
      padding:10px;
      border-radius:10px;
      border:1px solid #7f1d1d;
      background:#450a0a;
      color:#fecaca;
      font-size:14px;
      cursor:pointer;
    }
    .btn:disabled,.btn-secondary:disabled,.btn-danger:disabled{opacity:.5;cursor:not-allowed}
    .margem-ok{
      background:#022c22;
      border-color:#16a34a;
      color:#bbf7d0;
    }
    .margem-media{
      background:#422006;
      border-color:#facc15;
      color:#fef3c7;
    }
    .margem-baixa{
      background:#450a0a;
      border-color:#ef4444;
      color:#fee2e2;
    }
    .margem-ok::placeholder,
    .margem-media::placeholder,
    .margem-baixa::placeholder{
      color:inherit;
    }
    .footer{margin-top:4px;font-size:11px;color:var(--muted);text-align:right}
    .foto-preview{
      width:100%;
      max-height:220px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid #1f2937;
      background:#020617;
    }
    .error{color:var(--danger);font-size:12px;margin-top:4px}
    @media (min-width:768px){
      .grid-2-cols{display:grid;grid-template-columns:1.4fr 1fr;gap:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Calculadora de Custos</h1>
      <span class="pill">Produtos com foto ‚Ä¢ Offline</span>
    </header>

    <!-- BLOCO FOTO + DADOS DO PRODUTO -->
    <div class="card">
      <div class="grid">
        <div>
          <label>Foto do produto</label>
          <input id="fotoInput" type="file" accept="image/*" capture="environment">
          <div class="hint">Use a c√¢mera para registrar o produto. A imagem ser√° salva em tamanho reduzido neste aparelho.</div>
        </div>
        <div>
          <img id="fotoPreview" class="foto-preview" alt="Pr√©via da foto do produto" style="display:none;">
        </div>
        <div>
          <label for="nomeProduto">Nome do produto</label>
          <input id="nomeProduto" type="text" placeholder="Ex.: Detergente XYZ 5 L">
        </div>
        <div>
          <label for="detalhesProduto">Detalhes do produto</label>
          <textarea id="detalhesProduto" rows="3" placeholder="Ex.: Caixa com 4 gal√µes de 5 L (total 20 L). Peso bruto 22 kg."></textarea>
        </div>
        <div id="erroProduto" class="error"></div>
      </div>
    </div>

    <!-- BLOCO CALCULADORA -->
    <div class="card">
      <div class="grid">
        <div class="row">
          <div>
            <label for="fob">FOB</label>
            <input id="fob" type="text" inputmode="decimal" placeholder="ex.: 3,50">
          </div>
          <div>
            <label for="conversao">Convers√£o</label>
            <input id="conversao" type="text" inputmode="decimal" placeholder="ex.: 0,72">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="fator">Fator</label>
            <input id="fator" type="text" inputmode="decimal" placeholder="ex.: 1,60">
          </div>
          <div>
            <label for="custo">Custo</label>
            <input id="custo" type="text" readonly placeholder="C√°lculo: FOB √ó Convers√£o √ó Fator">
          </div>
        </div>

        <div class="row">
          <div>
            <label for="pdv">PDV</label>
            <input id="pdv" type="text" inputmode="decimal" placeholder="ex.: 14,99">
          </div>
          <div>
            <label for="impostos">Impostos (%)</label>
            <input id="impostos" type="text" inputmode="decimal" placeholder="ex.: 28,72">
            <div class="hint">Digite o percentual de impostos aplic√°vel a este produto.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="custoFinal">Custo final</label>
            <input id="custoFinal" type="text" readonly placeholder="C√°lculo: Custo + (PDV √ó Impostos%)">
          </div>
          <div>
            <label for="margem">Margem (%)</label>
            <input id="margem" type="text" readonly placeholder="Resultado em % com cor indicativa">
          </div>
        </div>

        <button id="btnSalvarProduto" class="btn" type="button">üíæ Salvar produto + c√°lculo</button>
        <button id="btnLimparCampos" class="btn-secondary" type="button">üßπ Limpar campos da tela</button>
      </div>
      <div class="footer">
        Margem &gt;= 60%: verde ‚Ä¢ 50‚Äì59,99%: amarelo ‚Ä¢ &lt; 50%: vermelho
      </div>
    </div>

    <!-- BLOCO HIST√ìRICO / RELAT√ìRIO -->
    <div class="card">
      <h2 style="margin-top:0;">Hist√≥rico de produtos</h2>
      <div class="grid">
        <textarea id="historico" rows="6" readonly placeholder="Nenhum produto salvo ainda."></textarea>
        <button id="btnRefreshLog" class="btn-secondary" type="button">üîÑ Atualizar hist√≥rico</button>
        <button id="btnPdf" class="btn-secondary" type="button">üìÑ Baixar relat√≥rio em PDF</button>
        <button id="btnWhatsPdf" class="btn-secondary" type="button">üì§ Enviar relat√≥rio em PDF (WhatsApp)</button>
        <button id="btnClearLog" class="btn-danger" type="button">üóëÔ∏è Limpar hist√≥rico</button>
        <div class="hint">
          Este hist√≥rico √© local deste aparelho e armazena <strong>apenas os √∫ltimos 50 produtos registrados</strong>,
          com foto, detalhes e c√°lculo de custo/margem.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======= Refer√™ncias aos elementos =======
    const fotoInput = document.getElementById('fotoInput');
    const fotoPreview = document.getElementById('fotoPreview');
    const nomeProduto = document.getElementById('nomeProduto');
    const detalhesProduto = document.getElementById('detalhesProduto');
    const erroProduto = document.getElementById('erroProduto');

    const fob = document.getElementById('fob');
    const conversao = document.getElementById('conversao');
    const fator = document.getElementById('fator');
    const custo = document.getElementById('custo');
    const pdv = document.getElementById('pdv');
    const impostos = document.getElementById('impostos');
    const custoFinal = document.getElementById('custoFinal');
    const margem = document.getElementById('margem');

    const btnSalvarProduto = document.getElementById('btnSalvarProduto');
    const btnLimparCampos = document.getElementById('btnLimparCampos');

    const historico = document.getElementById('historico');
    const btnRefreshLog = document.getElementById('btnRefreshLog');
    const btnPdf = document.getElementById('btnPdf');
    const btnWhatsPdf = document.getElementById('btnWhatsPdf');
    const btnClearLog = document.getElementById('btnClearLog');

    const LOG_KEY = 'calc-produtos-v1';
    const MAX_REGISTROS = 50;

    let fotoDataUrlAtual = null; // guarda a foto reduzida do produto atual

    // ======= Fun√ß√µes auxiliares num√©ricas =======
    function parseBR(str){
      if(!str) return NaN;
      let s = String(str).trim();
      s = s.replace(/\s+/g,'');
      const parts = s.split(',');
      if(parts.length > 2){
        const decimal = parts.pop();
        s = parts.join('') + ',' + decimal;
      }
      s = s.replace(/\./g,'');
      s = s.replace(',', '.');
      const n = Number(s);
      return isNaN(n) ? NaN : n;
    }

    function formatBR(n, decimals){
      if(n == null || isNaN(n)) return '';
      const d = (typeof decimals === 'number') ? decimals : 2;
      return n.toLocaleString('pt-BR', { minimumFractionDigits:d, maximumFractionDigits:d });
    }

    function limparMargemClasses(){
      margem.classList.remove('margem-ok','margem-media','margem-baixa');
    }

    // ======= Redimensionar imagem (para base64 menor) =======
    function reduzirImagem(arquivo, maxLargura=600){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width;
            let h = img.height;
            if(w > maxLargura){
              const ratio = maxLargura / w;
              w = maxLargura;
              h = h * ratio;
            }
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.8); // 80% qualidade
            resolve(dataUrl);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(arquivo);
      });
    }

    fotoInput.addEventListener('change', async () => {
      erroProduto.textContent = '';
      const arq = fotoInput.files && fotoInput.files[0];
      if(!arq){
        fotoDataUrlAtual = null;
        fotoPreview.style.display = 'none';
        fotoPreview.src = '';
        return;
      }
      try{
        const reduzida = await reduzirImagem(arq, 600);
        fotoDataUrlAtual = reduzida;
        fotoPreview.src = reduzida;
        fotoPreview.style.display = 'block';
      }catch(e){
        console.error(e);
        erroProduto.textContent = 'N√£o foi poss√≠vel carregar a foto. Tente novamente.';
        fotoDataUrlAtual = null;
        fotoPreview.style.display = 'none';
        fotoPreview.src = '';
      }
    });

    // ======= Recalcular custos/margem =======
    function recalcular(){
      const vFob = parseBR(fob.value);
      const vConv = parseBR(conversao.value);
      const vFator = parseBR(fator.value);
      const vPdv = parseBR(pdv.value);
      const vImpPerc = parseBR(impostos.value);

      let temBase = !isNaN(vFob) && !isNaN(vConv) && !isNaN(vFator);
      let temPdv = !isNaN(vPdv) && !isNaN(vImpPerc);

      let vCusto = NaN;
      let vCustoFinal = NaN;
      let vMargem = NaN;

      if(temBase){
        vCusto = vFob * vConv * vFator;
        custo.value = formatBR(vCusto, 4);
      } else {
        custo.value = '';
      }

      if(temBase && temPdv){
        vCustoFinal = vCusto + (vPdv * (vImpPerc/100));
        custoFinal.value = formatBR(vCustoFinal, 4);
        if(vCustoFinal > 0){
          vMargem = (vPdv / vCustoFinal) - 1;
          const perc = vMargem * 100;
          margem.value = formatBR(perc, 2) + ' %';
          limparMargemClasses();
          if(perc >= 60){
            margem.classList.add('margem-ok');
          }else if(perc >= 50){
            margem.classList.add('margem-media');
          }else{
            margem.classList.add('margem-baixa');
          }
        } else {
          margem.value = '';
          limparMargemClasses();
        }
      } else {
        custoFinal.value = '';
        margem.value = '';
        limparMargemClasses();
      }
    }

    [fob,conversao,fator,pdv,impostos].forEach(el => {
      el.addEventListener('input', recalcular);
    });

    // ======= Log local =======
    function carregarLog(){
      try{
        return JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
      }catch(e){
        return [];
      }
    }

    function salvarLog(log){
      localStorage.setItem(LOG_KEY, JSON.stringify(log));
    }

    function formatarData(iso){
      if(!iso) return '';
      const d = new Date(iso);
      if(isNaN(d)) return '';
      const pad = n => String(n).padStart(2,'0');
      return pad(d.getDate()) + '/' + pad(d.getMonth()+1) + '/' + d.getFullYear() +
             ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
    }

    function atualizarHistoricoTexto(){
      const log = carregarLog();
      if(!log.length){
        historico.value = 'Nenhum produto salvo ainda.';
        return;
      }
      const linhas = log.map((r,idx) => {
        const dataStr = formatarData(r.dataIso);
        const margemStr = (typeof r.margemPerc === 'number')
          ? formatBR(r.margemPerc, 2) + ' %'
          : '-';
        return '[' + dataStr + '] ' +
               (r.nome || 'Produto sem nome') +
               ' | Margem: ' + margemStr;
      });
      historico.value = linhas.join('\n');
    }

    btnRefreshLog.addEventListener('click', atualizarHistoricoTexto);

    btnClearLog.addEventListener('click', () => {
      const ok = confirm('Tem certeza que deseja limpar todo o hist√≥rico de produtos deste aparelho?');
      if(!ok) return;
      salvarLog([]);
      atualizarHistoricoTexto();
      erroProduto.textContent = '';
    });

    // ======= Salvar produto + c√°lculo =======
    btnSalvarProduto.addEventListener('click', () => {
      erroProduto.textContent = '';

      // Garante que o c√°lculo est√° atualizado
      recalcular();

      const nome = nomeProduto.value.trim();
      const detalhes = detalhesProduto.value.trim();
      const vFob = parseBR(fob.value);
      const vConv = parseBR(conversao.value);
      const vFator = parseBR(fator.value);
      const vPdv = parseBR(pdv.value);
      const vImpPerc = parseBR(impostos.value);
      const vCusto = parseBR(custo.value);
      const vCustoFinal = parseBR(custoFinal.value);
      const vMargemPerc = parseBR(margem.value.replace('%',''));

      // Regras m√≠nimas para salvar
      if(!fotoDataUrlAtual){
        erroProduto.textContent = 'Tire a foto do produto antes de salvar.';
        return;
      }
      if(!nome){
        erroProduto.textContent = 'Informe um nome para o produto.';
        return;
      }
      if(isNaN(vFob) || isNaN(vConv) || isNaN(vFator)){
        erroProduto.textContent = 'Preencha FOB, Convers√£o e Fator para calcular o custo.';
        return;
      }
      if(isNaN(vPdv) || isNaN(vImpPerc)){
        erroProduto.textContent = 'Preencha PDV e Impostos (%) para calcular custo final e margem.';
        return;
      }
      if(isNaN(vCusto) || isNaN(vCustoFinal) || isNaN(vMargemPerc)){
        erroProduto.textContent = 'N√£o foi poss√≠vel calcular custo/margem. Verifique os valores digitados.';
        return;
      }

      const agora = new Date();
      const id = 'P' + agora.getTime().toString();

      const registro = {
        id,
        dataIso: agora.toISOString(),
        nome,
        detalhes,
        fob: vFob,
        conversao: vConv,
        fator: vFator,
        custo: vCusto,
        pdv: vPdv,
        impostosPerc: vImpPerc,
        custoFinal: vCustoFinal,
        margemPerc: vMargemPerc,
        fotoDataUrl: fotoDataUrlAtual
      };

      let log = carregarLog();
      log.unshift(registro);
      if(log.length > MAX_REGISTROS){
        log = log.slice(0, MAX_REGISTROS);
      }
      salvarLog(log);
      atualizarHistoricoTexto();

      erroProduto.textContent = 'Produto salvo com sucesso.';
      setTimeout(() => { if(erroProduto.textContent === 'Produto salvo com sucesso.') erroProduto.textContent = ''; }, 2000);
    });

    // ======= Limpar campos da tela (mas n√£o o hist√≥rico) =======
    btnLimparCampos.addEventListener('click', () => {
      fotoInput.value = '';
      fotoDataUrlAtual = null;
      fotoPreview.style.display = 'none';
      fotoPreview.src = '';

      nomeProduto.value = '';
      detalhesProduto.value = '';
      [fob,conversao,fator,pdv,impostos,custo,custoFinal,margem].forEach(el => el.value = '');
      limparMargemClasses();
      erroProduto.textContent = '';
    });

    // ======= PDF do relat√≥rio =======
    async function gerarPdfBlobDoLog(){
      const log = carregarLog();
      if(!log.length){
        erroProduto.textContent = 'Nenhum produto no hist√≥rico para gerar PDF.';
        return null;
      }
      if(!window.jspdf || !window.jspdf.jsPDF){
        erroProduto.textContent = 'Biblioteca de PDF n√£o carregada (jsPDF). Verifique a conex√£o na primeira vez.';
        return null;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'p', unit:'mm', format:'a4'});

      doc.setFontSize(14);
      doc.text('RELATORIO DE PRODUTOS - CALCULADORA DE CUSTOS', 105, 12, { align: 'center' });

      let y = 20;
      const linha = 5;
      const larguraPagina = 210;
      const margemEsq = 10;
      const larguraTexto = larguraPagina - 2*margemEsq;

      doc.setFontSize(9);

      for(const r of log){
        if(y > 260){
          doc.addPage();
          y = 15;
        }

        const dataStr = formatarData(r.dataIso);
        doc.setFont(undefined, 'bold');
        doc.text((r.nome || 'Produto sem nome'), margemEsq, y);
        doc.setFont(undefined, 'normal');
        doc.text('Data: ' + dataStr, margemEsq, y + linha);

        y += linha*2;

        if(r.fotoDataUrl){
          try{
            const imgProps = doc.getImageProperties(r.fotoDataUrl);
            const imgWidthMax = 60;
            const imgHeight = (imgProps.height * imgWidthMax) / imgProps.width;
            if(y + imgHeight > 280){
              doc.addPage();
              y = 20;
            }
            doc.addImage(r.fotoDataUrl, 'JPEG', margemEsq, y, imgWidthMax, imgHeight);
            // bloco de texto ao lado da foto
            const xTexto = margemEsq + imgWidthMax + 4;
            const detalhes = r.detalhes || '';
            const wrapDetalhes = doc.splitTextToSize(detalhes, larguraTexto - imgWidthMax - 4);
            doc.text(wrapDetalhes, xTexto, y + 3);
            y += Math.max(imgHeight, wrapDetalhes.length * (linha-1)) + 2*linha;
          }catch(e){
            const detalhes = r.detalhes || '';
            const wrapDetalhes = doc.splitTextToSize(detalhes, larguraTexto);
            doc.text(wrapDetalhes, margemEsq, y);
            y += wrapDetalhes.length * linha + linha;
          }
        } else {
          const detalhes = r.detalhes || '';
          const wrapDetalhes = doc.splitTextToSize(detalhes, larguraTexto);
          doc.text(wrapDetalhes, margemEsq, y);
          y += wrapDetalhes.length * linha + linha;
        }

        const linhasTabela = [
          'FOB: ' + formatBR(r.fob,2) + ' | Conversao: ' + formatBR(r.conversao,4) + ' | Fator: ' + formatBR(r.fator,4),
          'Custo: ' + formatBR(r.custo,4) + ' | PDV: ' + formatBR(r.pdv,2),
          'Impostos: ' + formatBR(r.impostosPerc,2) + ' % | Custo final: ' + formatBR(r.custoFinal,4),
          'Margem: ' + formatBR(r.margemPerc,2) + ' %'
        ];
        for(const linhaTexto of linhasTabela){
          if(y > 280){
            doc.addPage();
            y = 20;
          }
          doc.text(linhaTexto, margemEsq, y);
          y += linha;
        }

        y += linha;
        if(y > 280){
          doc.addPage();
          y = 20;
        }
      }

      const blob = doc.output('blob');
      return blob;
    }

    btnPdf.addEventListener('click', async () => {
      const blob = await gerarPdfBlobDoLog();
      if(!blob) return;
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'relatorio_produtos_calculadora_custos.pdf';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    });

    btnWhatsPdf.addEventListener('click', async () => {
      const blob = await gerarPdfBlobDoLog();
      if(!blob) return;

      if(!navigator.share){
        erroProduto.textContent = 'Compartilhamento de arquivos n√£o √© suportado neste navegador/aparelho.';
        return;
      }

      const file = new File([blob], 'relatorio_produtos_calculadora_custos.pdf', { type: 'application/pdf' });

      if(navigator.canShare && !navigator.canShare({ files: [file] })){
        erroProduto.textContent = 'Este aparelho n√£o suporta compartilhar PDF pelo navegador.';
        return;
      }

      try{
        await navigator.share({
          files: [file],
          text: 'Relatorio de produtos - Calculadora de Custos'
        });
      }catch(e){
        console.error(e);
      }
    });

    // Atualiza hist√≥rico ao abrir
    atualizarHistoricoTexto();

    // Service Worker para PWA offline
    if('serviceWorker' in navigator){
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>
</body>
</html>
